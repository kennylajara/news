# Comparaci√≥n de Entidades

---

## Entidad A (Entidad a Evaluar)

**ID:** {{ entity_a_id }}
**Nombre:** {{ entity_a_name }}
**Tipo:** {{ entity_a_type }}
**Clasificaci√≥n actual:** {{ entity_a_classification }}
**Menciones totales:** {{ entity_a_mentions }} (en {{ entity_a_article_count }} art√≠culo{{ 's' if entity_a_article_count != 1 else '' }})

{% if entity_a_canonical_refs and entity_a_canonical_refs|length > 0 %}
**Referencias can√≥nicas actuales:**
{% for ref in entity_a_canonical_refs %}
- [ID: {{ ref.id }}] {{ ref.name }} ({{ ref.type }})
{% endfor %}
{% else %}
**Referencias can√≥nicas actuales:** Ninguna
{% endif %}

{% if entity_a_context and entity_a_context|length > 0 %}
### Contexto de Uso (Entidad A)

Ejemplos de c√≥mo se usa "{{ entity_a_name }}" en los art√≠culos:

{% for sentence in entity_a_context[:3] %}
{{ loop.index }}. {{ sentence }}
{% endfor %}
{% if entity_a_context|length > 3 %}
... ({{ entity_a_context|length - 3 }} oraciones adicionales omitidas)
{% endif %}
{% else %}
### Contexto de Uso (Entidad A)

No hay suficientes oraciones de contexto disponibles para esta entidad.
{% endif %}

---

## Entidad B (Candidato para Comparaci√≥n)

**ID:** {{ entity_b_id }}
**Nombre:** {{ entity_b_name }}
**Tipo:** {{ entity_b_type }}
**Clasificaci√≥n actual:** {{ entity_b_classification }}
**Menciones totales:** {{ entity_b_mentions }} (en {{ entity_b_article_count }} art√≠culo{{ 's' if entity_b_article_count != 1 else '' }})

{% if entity_b_canonical_refs and entity_b_canonical_refs|length > 0 %}
**Referencias can√≥nicas actuales:**
{% for ref in entity_b_canonical_refs %}
- [ID: {{ ref.id }}] {{ ref.name }} ({{ ref.type }})
{% endfor %}
{% else %}
**Referencias can√≥nicas actuales:** Ninguna
{% endif %}

{% if entity_b_context and entity_b_context|length > 0 %}
### Contexto de Uso (Entidad B)

Ejemplos de c√≥mo se usa "{{ entity_b_name }}" en los art√≠culos:

{% for sentence in entity_b_context[:3] %}
{{ loop.index }}. {{ sentence }}
{% endfor %}
{% if entity_b_context|length > 3 %}
... ({{ entity_b_context|length - 3 }} oraciones adicionales omitidas)
{% endif %}
{% else %}
### Contexto de Uso (Entidad B)

No hay suficientes oraciones de contexto disponibles para esta entidad.
{% endif %}

---

## An√°lisis de Co-Ocurrencia

**Art√≠culos compartidos:** {{ shared_articles }} de {{ entity_a_article_count }} art√≠culos donde aparece "{{ entity_a_name }}" ({{ "%.0f"|format((shared_articles / entity_a_article_count * 100) if entity_a_article_count > 0 else 0) }}%)

**Similitud de nombres (Jaccard):** {{ "%.2f"|format(jaccard_similarity) }}

{% if cooccurrence_sentences and cooccurrence_sentences|length > 0 %}
### Oraciones donde Co-Ocurren

Las siguientes oraciones muestran contextos donde AMBAS entidades aparecen juntas:

{% for sentence in cooccurrence_sentences[:3] %}
{{ loop.index }}. {{ sentence }}
{% endfor %}
{% if cooccurrence_sentences|length > 3 %}
... ({{ cooccurrence_sentences|length - 3 }} oraciones adicionales omitidas)
{% endif %}
{% else %}
### Oraciones donde Co-Ocurren

No se encontraron oraciones donde ambas entidades aparecen juntas. Esto podr√≠a indicar:
- Son la misma entidad (una es variaci√≥n de la otra, nunca aparecen simult√°neamente)
- Son entidades completamente distintas sin relaci√≥n
- Datos insuficientes
{% endif %}

---

## Tu Tarea

Analiza la informaci√≥n anterior y determina:

1. **Clasificaci√≥n para Entidad A (ID: {{ entity_a_id }}, "{{ entity_a_name }}"):**
   - ¬øDeber√≠a ser `canonical`, `alias`, `ambiguous`, o `not_an_entity`?

2. **Clasificaci√≥n para Entidad B (ID: {{ entity_b_id }}, "{{ entity_b_name }}"):**
   - ¬øDeber√≠a ser `canonical`, `alias`, `ambiguous`, o `not_an_entity`?

3. **Cambios en referencias can√≥nicas:**
   - Para clasificaciones `alias` o `ambiguous`: ¬øQu√© IDs agregar/quitar de `canonical_refs`?
   - **Importante**: Si una entidad YA tiene referencias correctas, reutil√≠zalas para la otra si aplica

4. **Confianza:** Del 0.0 al 1.0, ¬øqu√© tan seguro est√°s de tus decisiones?

5. **Razonamiento:** Explica brevemente (1-3 oraciones) citando evidencia espec√≠fica del contexto, co-ocurrencia, o referencias existentes.

---

## Consideraciones Importantes

{% if entity_a_mentions < 5 or entity_b_mentions < 5 %}
‚ö†Ô∏è **Advertencia:** Al menos una entidad tiene pocas menciones ({{ entity_a_mentions }} y {{ entity_b_mentions }}). S√© conservador con el nivel de confianza.
{% endif %}

{% if shared_articles == 0 %}
‚ö†Ô∏è **Advertencia:** Las entidades NO co-ocurren en ning√∫n art√≠culo. Esto dificulta el an√°lisis contextual.
{% endif %}

{% if jaccard_similarity > 0.7 %}
‚úÖ **Nota:** Los nombres son muy similares (similitud {{ "%.0f"|format(jaccard_similarity * 100) }}%). Probablemente son variaciones de la misma entidad.
{% elif jaccard_similarity < 0.3 %}
‚ö†Ô∏è **Nota:** Los nombres son bastante diferentes (similitud {{ "%.0f"|format(jaccard_similarity * 100) }}%). Verifica si hay relaci√≥n sem√°ntica m√°s all√° del nombre.
{% endif %}

{% if entity_a_type != entity_b_type %}
‚ö†Ô∏è **Advertencia:** Las entidades tienen tipos diferentes ({{ entity_a_type }} vs {{ entity_b_type }}). Esto podr√≠a indicar que son distintas, a menos que el NER haya cometido un error.
{% endif %}

{% if entity_a_canonical_refs and entity_a_canonical_refs|length > 0 %}
üí° **Informaci√≥n √∫til:** Entity A ya tiene referencias a {% for ref in entity_a_canonical_refs %}{{ ref.name }}{% if not loop.last %}, {% endif %}{% endfor %}. Considera si Entity B deber√≠a tener las mismas referencias.
{% endif %}

{% if entity_b_canonical_refs and entity_b_canonical_refs|length > 0 %}
üí° **Informaci√≥n √∫til:** Entity B ya tiene referencias a {% for ref in entity_b_canonical_refs %}{{ ref.name }}{% if not loop.last %}, {% endif %}{% endfor %}. Considera si Entity A deber√≠a tener las mismas referencias.
{% endif %}

---

## Recordatorio del Formato de Respuesta

Debes retornar exactamente:

```json
{
  "classification_changes": [
    {
      "entity_id": {{ entity_a_id }},
      "classification": "canonical|alias|ambiguous|not_an_entity"
    },
    {
      "entity_id": {{ entity_b_id }},
      "classification": "canonical|alias|ambiguous|not_an_entity"
    }
  ],
  "reference_changes": [
    {
      "entity_id": <ID de entidad a modificar>,
      "add_refs": [<lista de IDs a agregar>],
      "remove_refs": [<lista de IDs a quitar>] o null
    }
  ] o null,
  "confidence": 0.0-1.0,
  "reasoning": "Explicaci√≥n breve citando evidencia."
}
```

**Reglas:**
- `classification_changes` debe tener EXACTAMENTE 2 elementos (uno con ID {{ entity_a_id }}, otro con ID {{ entity_b_id }})
- `reference_changes` es opcional (solo si hay cambios)
- Los IDs en `reference_changes` deben ser {{ entity_a_id }} o {{ entity_b_id }}
- Los IDs en `add_refs` y `remove_refs` deben ser IDs de entidades CANONICAL existentes
